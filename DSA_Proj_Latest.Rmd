---
title: "DSA301 Project"
author: "Everyone"
output: html_document
---
Questions:
1. Decompose first or transform first (benchmark models)
2. Use checkresiduals or AICc to compare models?
3. How to read the PACF & ACF graphs? Currently just using guess and check from changing models provided by auto.arima

```{r cars}
# install.packages("pageviews")
# install.packages("jsonlite")
# install.packages("lubridate")
library(jsonlite)
library(pageviews)
library(lubridate)
library(dplyr)
library(forecast)
library(urca)
library(TSstudio)
rm(list = ls())
```

Getting the daily data
```{r pressure, echo=FALSE}
project = "en.wikipedia.org"
access = "all-access"
agent = "all-agents"
granularity = "daily"
start = "2015010100"
end = "2022013123"
url_daily = sprintf("https://wikimedia.org/api/rest_v1/metrics/pageviews/aggregate/%s/%s/%s/%s/%s/%s", project, access, agent, granularity, start, end)
url_hourly = sprintf("https://wikimedia.org/api/rest_v1/metrics/pageviews/aggregate/%s/%s/%s/%s/%s/%s", project, access, agent, "hourly", start, end)
daily_data = fromJSON(txt=url_daily)$items
hourly_data = fromJSON(txt= url_hourly)$items

```

Converting Raw Data to Time Series
```{r}
msts_wiki_daily <- daily_data$views %>% 
  msts(seasonal.periods = c(7, 365), 
       start = decimal_date(as.Date("2015-07-01")))

autoplot(msts_wiki_daily)
```

Splitting Test & Train Data
```{r}
wiki_daily_split <- ts_split(msts_wiki_daily, sample.out = 482)
```

Visualising & Decomposing Time Series
```{r}
wiki_daily_decomp_train <- mstl(wiki_daily_split$train)
autoplot(wiki_daily_decomp_train)
```

Transforming Seasonal Adjusted Component
```{r}
seasadj_wiki <- seasadj(wiki_daily_decomp_train)

#Test stat = 0.011
seasadj_wiki %>% 
  diff(lag =1)%>%
  ur.kpss()%>%
  summary()

#Test stat = 0.0142 
seasadj_wiki %>% 
  diff(lag =7)%>%
  ur.kpss()%>%
  summary()

#Test stat = 0.003
seasadj_wiki %>% 
  diff(lag =7)%>% 
  diff(lag = 1)%>%
  ur.kpss()%>%
  summary()

#Test stat = 2.2636
seasadj_wiki %>% 
  diff(lag = 365)%>%
  ur.kpss()%>%
  summary()

#Test stat = 0.0143
seasadj_wiki %>% 
  diff(lag =365)%>% 
  diff(lag = 1)%>%
  ur.kpss()%>%
  summary()

trans_seasadj_wiki_1 <- seasadj_wiki %>%diff(lag = 1)
trans_seasadj_wiki_2 <- seasadj_wiki %>%diff(lag = 7)%>%diff(lag = 1)
autoplot(trans_seasadj_wiki_1)
autoplot(trans_seasadj_wiki_2)
```


Fitting Models on Transformed Data
```{r}
#Benchmark Models (Need to clarify with Prof on how to transform back after we only apply differencing to seasonal adjusted component. Refer to Lecture 6 hmwk 2 code (he applied differencing to time series before decomposition))
b1 <- stlf(wiki_daily_split$train, method = "naive", robust = T)
b2 <- stlf(wiki_daily_split$train, method = "rwdrift", robust = T)
```

```{r}
#ARIMA Models
ggtsdisplay(seasadj_wiki)
pacf(seasadj_wiki)
acf(seasadj_wiki)

ggtsdisplay(trans_seasadj_wiki_1)
pacf(trans_seasadj_wiki_1)
acf(trans_seasadj_wiki_1)

ggtsdisplay(trans_seasadj_wiki_2)
pacf(trans_seasadj_wiki_2)
acf(trans_seasadj_wiki_2)
```

```{r}
#Testing out Seasonal ARIMA with stlm. NEED HELP WITH READING ACF & PACF!!! 
#ASK PROF ON THURSDAY. Update: Prof say can just mention that the graphs got show  some MA or AR orders and that supports our models (e.g. we got MA and AR components)

A0 <- auto.arima(ts(seasadj_wiki, frequency = 7)) #(4,1,1)(2,0,2)[7]
A1 <- Arima(seasadj_wiki, order=c(1,1,3), seasonal = list(order = c(3,0,3), period = 7))
A2 <- Arima(seasadj_wiki, order=c(2,1,3), seasonal = list(order = c(2,0,2), period = 7))
A3 <- Arima(seasadj_wiki, order=c(2,1,3), seasonal = list(order = c(1,0,3), period = 7))
A4 <- Arima(seasadj_wiki, order=c(2,1,3), seasonal = list(order = c(2,1,2), period = 7))
A5 <- Arima(seasadj_wiki, order=c(3,1,3), seasonal = list(order = c(2,1,2), period = 7))
A6 <- Arima(seasadj_wiki, order=c(4,1,3), seasonal = list(order = c(2,1,2), period = 7))
A7 <- Arima(seasadj_wiki, order=c(4,1,1), seasonal = list(order = c(2,1,2), period = 7))

model_AIC = data.frame(model = c("A0", "A1", "A2", "A3", "A4", "A5", "A6", "A7"),
                       AIC = c(A0$aic, A1$aic, A2$aic, A3$aic, A4$aic, A5$aic, A6$aic, A7$aic))
model_AIC


#Only only that passed were (4,1,3)(2,1,2)[7] and (4,1,3)(1,0,2)[7]
f0 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(4,1,1), 
         seasonal = list(order = c(2,0,2), period = 7), robust = T)

f1 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(1,1,3), 
         seasonal = list(order = c(3,0,3), period = 7), robust = T)

f2 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(2,1,3), 
         seasonal = list(order = c(2,0,2), period = 7), robust = T)

f3 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(2,1,3), 
         seasonal = list(order = c(1,0,3), period = 7), robust = T)

f4 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(2,1,3), 
         seasonal = list(order = c(2,1,2), period = 7), robust = T)

f5 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(3,1,3), 
         seasonal = list(order = c(2,1,2), period = 7), robust = T)

f6 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(4,1,3), 
         seasonal = list(order = c(2,1,2), period = 7), robust = T)

f7 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(4,1,1), 
         seasonal = list(order = c(2,1,2), period = 7), robust = T)

checkresiduals(forecast(f0))
checkresiduals(forecast(f1))
checkresiduals(forecast(f2))
checkresiduals(forecast(f3))
checkresiduals(forecast(f4))
checkresiduals(forecast(f5))
checkresiduals(forecast(f6))
checkresiduals(forecast(f7))
checkresiduals(b1)
checkresiduals(b2)

#Only f5 and f6 passed the Ljung-Box Test for the train set
accuracy(forecast(f5), wiki_daily_split$test)
accuracy(forecast(f6), wiki_daily_split$test)


autoplot(msts_wiki_daily)+autolayer(forecast(f5), PI = F, alpha = 0.7, col = "red")
```


```{r}
#Miscellaneous

wiki_daily_single_yearly <- msts(ts(msts_wiki_daily), seasonal.periods = 365.25)
wiki_daily_single_weekly <- msts(ts(msts_wiki_daily), seasonal.periods = 7)


wiki_daily_split <- ts_split(msts_wiki_daily, sample.out = 482)
wiki_daily_single_yearly_split <- ts_split(wiki_daily_single_yearly, sample.out = 482)
wiki_daily_single_weekly_split <- ts_split(wiki_daily_single_weekly, sample.out = 482)
accuracy(stlf(wiki_daily_split$train), wiki_daily_split$test)
accuracy(stlf(wiki_daily_single_yearly_split$train), wiki_daily_single_yearly_split$test)
accuracy(stlf(wiki_daily_single_weekly_split$train), wiki_daily_single_weekly_split$test)
```

