---
title: "DSA301 Project"
author: "Everyone"
output: html_document
---
Questions:
1. Decompose first or transform first (benchmark models)
2. Use checkresiduals or AICc to compare models?
3. How to read the PACF & ACF graphs? Currently just using guess and check from changing models provided by auto.arima

```{r cars}
# install.packages("pageviews")
# install.packages("jsonlite")
# install.packages("lubridate")
library(jsonlite)
library(pageviews)
library(lubridate)
library(dplyr)
library(forecast)
library(urca)
library(TSstudio)
rm(list = ls())
```

Getting the daily data
```{r pressure, echo=FALSE}
project = "en.wikipedia.org"
access = "all-access"
agent = "all-agents"
granularity = "daily"
start = "2015010100"
end = "2022013123"
url_daily = sprintf("https://wikimedia.org/api/rest_v1/metrics/pageviews/aggregate/%s/%s/%s/%s/%s/%s", project, access, agent, granularity, start, end)
url_hourly = sprintf("https://wikimedia.org/api/rest_v1/metrics/pageviews/aggregate/%s/%s/%s/%s/%s/%s", project, access, agent, "hourly", start, end)
daily_data = fromJSON(txt=url_daily)$items
hourly_data = fromJSON(txt= url_hourly)$items

```

Converting Raw Data to Time Series
```{r}
msts_wiki_daily <- daily_data$views %>% 
  msts(seasonal.periods = c(7, 365), 
       start = decimal_date(as.Date("2015-07-01")))

autoplot(msts_wiki_daily)
```

Splitting Test & Train Data
```{r}
wiki_daily_split <- ts_split(msts_wiki_daily, sample.out = 482)
```

Visualising & Decomposing Time Series
```{r}
wiki_daily_decomp_train <- mstl(wiki_daily_split$train)
autoplot(wiki_daily_decomp_train)
```

Transforming Seasonal Adjusted Component
```{r}
seasadj_wiki <- seasadj(wiki_daily_decomp_train)

#Test stat = 0.011
seasadj_wiki %>% 
  diff(lag =1)%>%
  ur.kpss()%>%
  summary()

#Test stat = 0.0142 
seasadj_wiki %>% 
  diff(lag =7)%>%
  ur.kpss()%>%
  summary()

#Test stat = 0.003
seasadj_wiki %>% 
  diff(lag =7)%>% 
  diff(lag = 1)%>%
  ur.kpss()%>%
  summary()

#Test stat = 2.2636
seasadj_wiki %>% 
  diff(lag = 365)%>%
  ur.kpss()%>%
  summary()

#Test stat = 0.0143
seasadj_wiki %>% 
  diff(lag =365)%>% 
  diff(lag = 1)%>%
  ur.kpss()%>%
  summary()

trans_seasadj_wiki <- seasadj_wiki %>% diff(lag = 1)
autoplot(trans_seasadj_wiki)
```




Fitting Models on Transformed Data
```{r}
#Benchmark Models (Need to clarify with Prof on how to transform back after we only apply differencing to seasonal adjusted component. Refer to Lecture 6 hmwk 2 code (he applied differencing to time series before decomposition))


#ARIMA Models
ggtsdisplay(trans_seasadj_wiki)
Pacf(trans_seasadj_wiki)
Acf(trans_seasadj_wiki)


#Testing out Seasonal ARIMA with stlm. NEED HELP WITH READING ACF & PACF!!! 
#GRILL PROF ON THURSDAY

auto.arima(ts(seasadj_wiki, frequency = 7)) #(4,1,1)(2,0,2)[7]

#Ask prof why does this not work. When I tried it on the seasonal adjusted comp. of full data by accident, this does not throw the Error in optim(init[mask], armafn, method = optim.method, hessian = TRUE, : non-finite finite-difference value [7]. Even when using stlm on training data there is no error. Why is it that when i use Arima on training data, in the below comment it doesn't work?

# m1 <-  Arima(seasadj_wiki, order=c(4,1,1), seasonal = list(order = c(2,0,2), period = 7))

f0 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(4,1,1), 
         seasonal = list(order = c(2,0,2), period = 7), robust = T)

f1 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(4,1,3), 
         seasonal = list(order = c(1,0,2), period = 7), robust = T)

f2 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(4,1,2), 
         seasonal = list(order = c(1,0,2), period = 7), robust = T)

f3 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(4,1,1), 
         seasonal = list(order = c(1,1,2), period = 7), robust = T)

f4 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(4,1,1), 
         seasonal = list(order = c(2,1,2), period = 7), robust = T)

f5 = stlm(wiki_daily_split$train, modelfunction = Arima, order=c(3,1,1), 
         seasonal = list(order = c(2,0,1), period = 7), robust = T)


checkresiduals(forecast(f0))
checkresiduals(forecast(f1))
checkresiduals(forecast(f2))
checkresiduals(forecast(f3))
checkresiduals(forecast(f4))

#Only f1 passed the Ljung-Box Test for the train set
accuracy(forecast(f1), wiki_daily_split$test)

autoplot(msts_wiki_daily)+autolayer(forecast(f1), PI = F, alpha = 0.7, col = "red")
```


```{r}
#Miscellaneous

wiki_daily_single_yearly <- msts(ts(msts_wiki_daily), seasonal.periods = 365.25)
wiki_daily_single_weekly <- msts(ts(msts_wiki_daily), seasonal.periods = 7)


wiki_daily_split <- ts_split(msts_wiki_daily, sample.out = 482)
wiki_daily_single_yearly_split <- ts_split(wiki_daily_single_yearly, sample.out = 482)
wiki_daily_single_weekly_split <- ts_split(wiki_daily_single_weekly, sample.out = 482)
accuracy(stlf(wiki_daily_split$train), wiki_daily_split$test)
accuracy(stlf(wiki_daily_single_yearly_split$train), wiki_daily_single_yearly_split$test)
accuracy(stlf(wiki_daily_single_weekly_split$train), wiki_daily_single_weekly_split$test)
```

